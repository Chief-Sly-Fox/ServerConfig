register_command(herotransform, 

    array(
        description: 'Transform into a powered up hero',
        usage: '/herotransform <id>',
        permission: 'powers.herotransform',
        noPermMsg: 'Sorry you don\'t have permission to use this command.',
    
        executor: closure(@alias, @sender, @args) {
       
            if(array_size(@args) != 1){
                include('/home/minecraft/server/plugins/CommandHelper/includes/getHeroClass.ms')
                @class = _getheroclass(@sender)
                @contents = read('/home/minecraft/server/plugins/CommandHelper/LocalPackages/commands/chars/'.@class.'.yml')
                @hero = yml_decode(@contents)
                @alts = @hero['alts']
                msg(color(RED).'The available transformations you have are:')
                foreach(@alt in @alts){
                    try{
                        @contents = read('/home/minecraft/server/plugins/CommandHelper/LocalPackages/commands/chars/'.@alt.'.yml')
                        @hero = yml_decode(@contents)
                        runas(~console,'/tellraw '.@sender.' {"text":"'.@hero['name'].'","color":"gold","clickEvent":{"action":"run_command","value":"/herotransform '.@alt.'"},"hoverEvent":{"action":"show_text","value":"'.@alt.'"}}')
                    }catch(IOException @e){}
                }
                return(false)
            }
 
            @idToBe = @args[0]
            include('/home/minecraft/server/plugins/CommandHelper/includes/getHeroClass.ms')
            @player = player()
            @class = _getheroclass(@player)

            @contents = read('/home/minecraft/server/plugins/CommandHelper/LocalPackages/commands/chars/'.@class.'.yml')
            @hero = yml_decode(@contents)
            if(!array_index_exists(@hero,'alts')){
                msg(color(RED).'Sorry, your character doesn\'t have any available transformations')
                die()
            }

            @alts = @hero['alts']
            @goAhead = false

            foreach(@alt in @alts){
                if(@alt == @idToBe){
                    @goAhead = true
                }
            }

            if(@goAhead){
        
                runas(~console,'/pex user '.@player.' group set '.@idToBe)
                set_timeout(1000,closure(
                    run_cmd('/fixskin')
                ))
                if(has_permission(@player,'essentials.fly')){
                    run_cmd('/fly on')
                }
                if(has_permission(@player,'ch.alias.buff')){
                    runas(~console,'/minecraft:effect '.@player.' clear')
                    runas(~console,'/minecraft:clear '.@player)
                    runas(@player,'/buff')
                }

                @contents = read('/home/minecraft/server/plugins/CommandHelper/LocalPackages/commands/chars/'.@class.'.yml')
                @hero = yml_decode(@contents)
                @oldHero = @hero
                @contents = read('/home/minecraft/server/plugins/CommandHelper/LocalPackages/commands/chars/'.@idToBe.'.yml')
                @hero = yml_decode(@contents)
                @newHero = @hero
                broadcast(color(BLUE).@player.color(GRAY).' has performed a hero transformation from '.@oldHero['name'].color(GRAY).' to '.@newHero['name'].color(GRAY).' !')
                if(@newHero['trail'] != ''){
                    sudo("/trailsid ".@newHero['trail'])
                }else{
                    sudo("/trailsid none")
                }
                sudo('/powers')

            }else{
                msg(color(RED).'Sorry, the available transformations you have are:')
                foreach(@alt in @alts){
                    try{
                        @contents = read('/home/minecraft/server/plugins/CommandHelper/LocalPackages/commands/chars/'.@alt.'.yml')
                        @hero = yml_decode(@contents)
                        runas(~console,'/tellraw '.@sender.' {"text":"'.@hero['name'].'","color":"gold","clickEvent":{"action":"run_command","value":"/herotransform '.@alt.'"},"hoverEvent":{"action":"show_text","value":"'.@alt.'"}}')
                    }catch(IOException @e){}
                }
            }

        }
    )
)
